<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sales Order</title>

    <!-- <link rel="stylesheet" href="../../../css/style.css"> -->
    <link rel="stylesheet" href="../../../css/salesStyle.css">
    <!-- <link rel="stylesheet" href="css/component.css"> -->

    <!-- bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!-- Font Awesome -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js"
        integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous">
    </script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js"
        integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous">
    </script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <style>
        /* .pm-0 {
            padding: 0px !important;

            margin: 0px !important;
        } */

        .pm-0 {
            padding: 0px !important;

            margin: 0px !important;
        }

        tr td {
            padding: 2px !important;
            margin: 0 !important;
        }

        tr th {
            padding: 2px !important;
            margin: 0 !important;
        }

        body {
            /* overflow: hidden;
            sc */
            margin: 0;
            padding: 0;
            font-family: 'Gill Sans', 'Gill Sans MT', 'Calibri', 'Trebuchet MS', sans-serif

        }
        input{
            font-size: 12px !important;
            padding: 5px !important;
            max-height: 30px !important;
        }
        .col-4  p{
            font-size: 12px !important
        }
        select {
            font-size: 12px !important;
            padding: 5px !important;
            max-height: 30px !important;
        }
        thead td {
            font-size: 12px !important;
        }
        .cont {
            overflow: scroll;
            
        }
        .list_cont {
           list-style: none;
           margin: 0;
           padding: 0
        }
        .pointer {
            cursor: pointer;
        }
        .pointer:hover {
           background: rgb(255, 241, 223)
        }
       
    </style>

</head>

<body onload="fill()">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <img src="../../../assets/img/aa-logo.jpg" class=" float-right md-logo" alt="logo"
            width="70px">
        <a class="navbar-brand text-dark navbar-left ml-3" href="/">
                
            ABBAS ALI & SONS UNIFORMS AND TEXTILES
        </a>
        <button class="navbar-toggler bg-dark" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div>
            &nbsp;
        </div>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto text-light">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-dark" href="#" id="navbarDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Sales
                    </a>
                    <div class="dropdown-menu text-light bg-dark" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item text-info" href="/sale/sales_order">Sales Order</a>
                        <a class="dropdown-item text-info" href="/sale/packing_list">Packing List</a>
                        <a class="dropdown-item text-info" href="/sale/commercial_invoice">Commercial Invoice</a>
                        <a class="dropdown-item text-info" href="/sale/reciept_voucher">Reciept Voucher</a>

                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-dark" href="#" id="navbarDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Purchase
                    </a>
                    <div class="dropdown-menu text-light bg-dark" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item text-info" href="/purchase/purchase_order">Purchase Order</a>
                        <a class="dropdown-item text-info" href="/purchase/gr_note">Good Recieving Note / Invoice</a>
                        <a class="dropdown-item text-info" href="/purchase/payment_voucher">Vendor Payment</a>
                    </div>
                </li>



                <li class="nav-item">
                    <a class="nav-link text-dark" href="/production">Production</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-dark" href="#" id="navbarDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Reports
                    </a>
                    <div class="dropdown-menu text-dark bg-dark" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item text-info" href="/reports/sales_report">Sales Report</a>
                        <a class="dropdown-item text-info" href="/reports/purchase_report">Purchase Report</a>
                        <a class="dropdown-item text-info" href="/reports/production_report">Production Report</a>
                        <a class="dropdown-item text-info" href="/reports/accounts_report">Accounts Report</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="/master" tabindex="-1" aria-disabled="true">Master Data</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-dark" href="/master_view" tabindex="-1" aria-disabled="true">Master
                        View</a>
                </li>
            </ul>

        </div>
    </nav>
<hr class="pm-0">


  <div class="mt-1">
        <div class="row">
                <div class="col-md-3">
                    <div class="alert-dark  cont" style="height: 100%">
                       
                        <div class="container-fluid  text-dark">
                                <h4 class="text-left">SALES ORDER</h4>
                                <!-- <h6>Edit Old Sales Order</h6> -->
                                    <h6>Search</h6>

                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group m-1">
                                        <input type="text" placeholder="Search by LPO#" id='input_search_lpo'
                                            class="form-control" list='lpo_data_list'>
                                        <datalist id='lpo_data_list'>

                                        </datalist>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group m-1">
                                        <input type="text" placeholder="Search by Customer" id='input_search_client'
                                            class="form-control" list='client_data_list'>
                                        <datalist id='client_data_list'>

                                        </datalist>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group m-1">
                                            <select id="input_search_order_state">
                                                <option value="">All Orders</option>
                                                <option value="active">Active Orders</option>
                                                <option value="draft">Draft Orders</option>
                                                <option value="completed">Completed Orders</option>
                                            </select>
                                           
                                        </div>
                                    </div>
                                </div>
                            <div class="row">
                                <div class="col-md-12">
                                        <button class='float-right btn btn-sm btn-primary mr-1' onClick='lpo_refresh()' >Refresh</button>
                                    <!-- <button class='float-right btn btn-primary mr-1' onClick='lpo_search()'>Search</button> -->
                                </div>
                            </div>
                        </div>
                        <hr class="m-1">
                        <div class="list_cont" id='lpo_list'>

                        </div>
        
                    </div>
                </div>
        
                <div class="col-md-9 bg-light pm-0">
                    
                    <div id="main" class="">
                        <ul>
                            <li onClick="new_order()">New</li>
                            <li onClick="lpo_action('draft')">Save as draft</li>
                            <li onClick="print_order()">Print</li>
                            <li onClick="email_order()">Email</li>
                            <li onClick="cancel_order()">Cancel Sales Order</li>
                            <li onClick="delete_order()">Delete</li>

                        </ul>
        
                        <div id="content" class=" container-fluid">
        
                            <div class=" pm-0 sales-container " id="main_place">
        
                                <div class="packing-slip-header pm-0 bg-light">
        
                                    <div class="row p-3">
                                        <div class="col-4">
                                            <h5 class="pm-0">Bill To:</h5>
                                            <hr class="pm-0">
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Customer:</p>
                                                </div>
                                                <div class="col-7">
                                                    <select name="vender-info" id="pur-company-name" class="form-control"
                                                        onchange="fill_client()">
        
                                                    </select>
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Name:</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" name="vender-info" id="pur-name" class="form-control">
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Street Address</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" name="vender-info" id="pur-vender-address"
                                                        class="form-control">
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>City or ZIP:</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" name="vender-info" id="pur-vender-city"
                                                        class="form-control">
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Phone:</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" name="vender-info" id="pur-vender-phone"
                                                        class="form-control">
                                                </div>
                                            </div>
        
                                        </div>
        
                                        <div class="col-4">
                                            <h5 class="pm-0">Ship To:</h5>
                                            <hr class="pm-0">
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Name:</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" name="ship-info" id="pur-ship-name" class="form-control">
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Company Name:</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" name="ship-info" id="pur-ship-company-name"
                                                        class="form-control">
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Street Address</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" name="ship-info" id="pur-ship-address"
                                                        class="form-control">
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>City or ZIP:</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" name="ship-info" id="pur-ship-city" class="form-control">
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Phone:</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" name="ship-info" id="pur-ship-phone"
                                                        class="form-control">
                                                </div>
                                            </div>
        
                                        </div>
        
        
                                        <div class="col-4">
                                            <h5 class="pm-0">Sales Order</h5>
                                            <hr class="pm-0">
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Order Date:</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="date" class="form-control" id="pur-date">
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Due Date(Upto):</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="date" class="form-control" id="pur-date-2">
                                                </div>
                                            </div>
        
                                            <div class="row">
                                                <div class="col-5">
                                                    <p>Customer P.O#</p>
                                                </div>
                                                <div class="col-7">
                                                    <input type="text" class="form-control" id="pur-po">
                                                </div>
                                            </div>
                                            <div class="row">
                                                    <div class="col-5">
                                                        <p>Order Status</p>
                                                    </div>
                                                    <div class="col-7">
                                                        <input type="text" value="draft" class="form-control" id="pur-os" disabled>
                                                    </div>
                                                </div>
                                            <hr class="pm-0">
                                            <div class="row">
                                                <table class='table table-bordered col-md-12 table-hover table-condensed'>
                                                    <thead>
                                                        <tr>
                                                            <th>Sales Tax %</th>
                                                            <th>Discount</th>
                                                            <th>Currency</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td><input class='form-control' id='tax' type="number" value=0
                                                                    min="0" max="30" onkeyup="grand_total()"/></td>
                                                            <td><input class="form-control" id='discount' type='number' value=0
                                                                    min="0" max="999999" onkeyup="grand_total()" /></td>
                                                            <td> <select class='form-control' id='currency'
                                                                    onchange="currency_effect(this)"
                                                                    onclick="apply_currency(this)">
                                                                    <option value='PKR'>PKR</option>
                                                                    <option value='USD'>USD</option>
                                                                    <option value='EURO'>EURO</option>
                                                                    <option value='GBP'>GBP</option>
                                                                    <option value='AED'>AED</option>
                                                                </select></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
        
                                    </div>
                                </div>
        
                                <!-- packing address section -->
                                <!-- <div class="supply-content">
                                <div class="row">
                                  
            
                                </div>
                            </div>
                            -->
                                <div class="container-fluid">
                                   
                                                <table class="table table-bordered">
                                                        <thead>
                                                            <tr class="d-flex">
                                                                <td class="col-3">Product Category</td>
                                                                <td class="col-5">Description</td>
                                                                <td class="col-2">Order Qty</td>
                                                                <td class="col-2">Unit Price</td>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="items_table">
                                                            <tr class="d-flex">
                                                                <td class="col-3 td-cells">
                                                                    <select class="form-control" id="pro1category" onclick="load_items(this)"
                                                                        onchange="set_item(this)">
                                                                        <option>Select Product</option>
                                                                    </select>
                                                                </td>
                                                                <td class="col-5 td-cells">
                                                                    <input type="text" class="form-control" id="pro1description">
                                                                </td>
                                                                <td class="col-2 td-cells">
                                                                    <input type="text" class="form-control" id="pro1quantityorder"
                                                                        onkeyup="calc(this)">
                                                                </td>
                                                                <td class="col-2 td-cells">
                                                                    <input  type="text" class="form-control" id="pro1unitprice"
                                                                        onKeyUp="grand_total()"
                                                                        onkeypress="sales_add_new(event)">
                                                                </td>
                        
                                            
                                                            </tr>
                                                        </tbody>
                                                        <tfoot>
                                                            <tr class='d-flex'>
                                                                <th class='col-8'></th>
                                                                <th class='col-1'>Total Qty:</th>
                                                                <th class='col-1' id='total_qty'></th>
                                                                <th class='col-1'>Gross Total:</th>
                                                                <th class='col-1' id='gross_total'></th>
                                                            </tr>
                                                            <tr class='d-flex'>
                                                                    <th class='col-10'></th>
                                                                    <th class='col-1'>After Discount Deduction:</th>
                                                                    <th class='col-1' id='deduction'></th>
                                                                </tr>
                                                            <tr class='d-flex'>
                                                                    <th class='col-10'></th>
                                                                    <th class='col-1'>Tax % inclusive:</th>
                                                                    <th class='col-1' id='inclusive'></th>
                                                            </tr>
                                                            <tr class='d-flex'>
                                                                    <th class='col-10'></th>
                                                                    <th class='col-1'>Grand Total:</th>
                                                                    <th class='col-1' id='grand_total'></th>
                                                                </tr>
                                                            
                                                        </tfoot>
                                                    </table>
                                </div>
        
                                <section class="color-1 text-center">
                                    <p>
                                        <a class='btn btn-primary' data-toggle="modal" data-target="#myModal">Terms and
                                            Condition</a>
                                        <button onclick="lpo_action('active')" class="btn btn-primary " disabled
                                            id='lpo_btn'>Generate</button>
        
                                        <!-- <button onclick="salesOrder('operation1')" class="btn btn-primary ">Generate</button> -->
                                    </p>
                                </section>
        
                            </div>
        
                        </div>
        
        
                    </div>
                </div>
            </div>
  </div>



    <!--- modal-->
    <!-- The Modal -->
    <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Terms and Conditions</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <p id="sales_terms">Loading....</p>

                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="activate_btn()" data-dismiss="modal">Accept
                        Terms & Conditions</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

   

</body>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous">
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous">
</script>

<script src="../../../js/app.js"></script>

<script>
        let clients, items, styles, lpos, USD, GBP, AED, EURO;

     function fill() {
        let select_client = document.getElementById('pur-company-name');
        document.getElementById('pur-po').value = Math.floor(Math.random() * 100000);

        let select_item = document.getElementById('pro1category');
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let str = '<option value="">Select Customer</option>';
                clients = JSON.parse(this.responseText).clients;
                clients.forEach(client => {
                    str += `<option value='` + client.company_name + `'>` + client.company_name +
                        `</option>`
                });
                select_client.innerHTML = str;
                document.getElementById('client_data_list').innerHTML = str;

                //  console.log(clients);
            }
        };
        xhttp.open("GET", "/get_clients", true);
        xhttp.send();
        var xhttp2 = new XMLHttpRequest();
        xhttp2.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let str = '<option value="">Select Product</option>';
                items = JSON.parse(this.responseText).items;
                items.forEach(item => {
                    str += `<option value='` + item.name + `'>` + item.name + `</option>`
                });
                select_item.innerHTML = str;
                // console.log(items);
            }
        };
        xhttp2.open("GET", "/get_items", true);
        xhttp2.send();

        var xhttp3 = new XMLHttpRequest();
        xhttp3.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("sales_terms").innerHTML = JSON.parse(this.responseText).info[0].sales_terms
                USD = JSON.parse(this.responseText).info[0].USD;
                GBP = JSON.parse(this.responseText).info[0].GBP;
                EURO = JSON.parse(this.responseText).info[0].EURO;
                AED = JSON.parse(this.responseText).info[0].AED;
            }
        };
        xhttp3.open("GET", "/get_info", true);
        xhttp3.send();
        // LPOS
        var xhttp4 = new XMLHttpRequest();
        xhttp4.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                lpos = JSON.parse(this.responseText).lpos;
                populate_lpos();
                console.log("lpos", lpos);
            }
        };
        xhttp4.open("GET", "/get_lpos", true);
        xhttp4.send();


    }
   
    function grand_total(){
        let tr =  document.getElementById('items_table').getElementsByTagName('tr');
       let i , len = tr.length , total = 0;
       for(i = 0 ; i < len ; i++)
       {    let qty = parseInt(tr[i].getElementsByTagName('td')[2].getElementsByTagName('input')[0].value)
           let val = parseFloat(tr[i].getElementsByTagName('td')[3].getElementsByTagName('input')[0].value);
            if(!isNaN(val) && !isNaN(qty))
            {
                total += Math.round( val*qty );
            }
       }
       let d_dec = total -  parseInt(document.getElementById('discount').value);
       let inc =  (parseInt(document.getElementById('tax').value) * d_dec) / 100;
       let g_total  = inc + d_dec;
       document.getElementById('gross_total').innerHTML = total;
       document.getElementById('deduction').innerHTML = d_dec;
       document.getElementById('inclusive').innerHTML = inc;

       document.getElementById('grand_total').innerHTML = g_total;
       
    }
    function total_qty(){
       let tr =  document.getElementById('items_table').getElementsByTagName('tr');
       let i , len = tr.length , total_qty = 0;
       for(i = 0 ; i < len ; i++)
       {
           let val = parseInt(tr[i].getElementsByTagName('td')[2].getElementsByTagName('input')[0].value);
            if(!isNaN(val))
            {
                total_qty += val ;
            }
       } 
       document.getElementById('total_qty').innerHTML = total_qty;
    
    }
    function calc(e) {
        total_qty();
        let price = e.parentNode.parentNode.getElementsByTagName('td')[3].getElementsByTagName('input')[0]
        // let total = e.parentNode.parentNode.getElementsByTagName('td')[4].getElementsByTagName('input')[0];
        // let final;
        // final = parseFloat(price.value) * parseFloat(e.value)
        // total.value = final.toFixed(2);
        grand_total();
    }


    function populate_lpos(){
        let str = `<ul class="list_cont p-1">`;
        let str2 = ``;
        lpos.forEach((lpo)=>{
            str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`
            str2 += `<option value='${lpo.ref}'>${lpo.ref}</option>`
        });
        str += '</ul>'
        document.getElementById('lpo_data_list').innerHTML = str2;
        document.getElementById('lpo_list').innerHTML = str;
    }
    function activate_btn() {
        document.getElementById('lpo_btn').disabled = false;
    }

    function set_item(e) {
        // alert(e.value);
        let value = e.value;
        let detail = e.parentNode.parentNode.getElementsByTagName('td')[1].getElementsByTagName('input')[0];
        let price = e.parentNode.parentNode.getElementsByTagName('td')[3].getElementsByTagName('input')[0];

        items.forEach((item) => {
            if (item.name === value) {
                detail.value = item.detail;
                price.value = item.price;
                price.setAttribute("data-price", item.price);
            }
        })
    }

    function load_items(e) {
        let str = '<option value="">Select Product</option>';
        console.log(items);
        if (e.innerHTML.length < 10) {
            console.log("yees----------")
            items.forEach((item) => {
                str += `<option>` + item.name + `</option>`;
            });
            e.innerHTML = str;
        }



    }

    function fill_client() {
        let name = document.getElementById('pur-company-name').value;
        if (name === "") {
            document.getElementById('pur-name').value = '';
            document.getElementById('pur-vender-address').value = '';
            document.getElementById('pur-vender-city').value = '';
            document.getElementById('pur-vender-phone').value = '';
            document.getElementById('pur-ship-phone').value = '';
            document.getElementById('pur-ship-name').value = '';
            document.getElementById('pur-ship-address').value = '';
            document.getElementById('pur-ship-city').value = '';
            document.getElementById('pur-ship-company-name').value = '';



        } else {
            clients.forEach((client) => {
                if (name === client.company_name) {
                    document.getElementById('pur-name').value = client.name;
                    document.getElementById('pur-ship-name').value = client.name;
                    document.getElementById('pur-vender-address').value = client.street;
                    document.getElementById('pur-ship-address').value = client.street;
                    document.getElementById('pur-vender-city').value = client.city;
                    document.getElementById('pur-ship-city').value = client.city;
                    document.getElementById('pur-vender-phone').value = client.phone;
                    document.getElementById('pur-ship-phone').value = client.phone;
                    document.getElementById('pur-ship-company-name').value = client.company_name;

                }
            })

        }

    }
    function get_table_items(){
        let items_array = [],
         table = document.getElementById('items_table');
            let tr = table.getElementsByTagName('tr');
            let item, description, quantity, price, obj;
            for (let i = 0; i < tr.length; i++) {
                item = tr[i].getElementsByTagName('td')[0].getElementsByTagName('select')[0].value;
                description = tr[i].getElementsByTagName('td')[1].getElementsByTagName('input')[0].value;
                quantity = tr[i].getElementsByTagName('td')[2].getElementsByTagName('input')[0].value;
                price = tr[i].getElementsByTagName('td')[3].getElementsByTagName('input')[0].value;
                
                if( item !== "" &&  
                   !isNaN(quantity) && quantity > 0 &&
                   !isNaN(price) && price > 0 ){
                    obj = {
                    item: item,
                    description: description,
                    quantity: parseInt(quantity),
                    price: parseFloat(price).toFixed(2)
                };
                items_array.push(obj);
                   }
              

            };
            return items_array;
    }
    function get_items_total(arr){
        let total = 0 ;
        arr.forEach((a)=>{
            total +=  a.quantity * a.price;
        })
        return total;
    }
    function lpo_action(status) {
            
        let btn = document.getElementById('lpo_btn');
        btn.disabled = true;
        let pur_name = document.getElementById('pur-name').value;
        let pur_vendor_address = document.getElementById('pur-vender-address').value;
        let pur_vendor_city = document.getElementById('pur-vender-city').value;
        let pur_vendor_phone = document.getElementById('pur-vender-phone').value;
        let pur_company_name = document.getElementById('pur-company-name').value;
        let pur_ship_name = document.getElementById('pur-ship-name').value;
        let pur_ship_address = document.getElementById('pur-ship-address').value;
        let pur_ship_city = document.getElementById('pur-ship-city').value;
        let pur_ship_phone = document.getElementById('pur-ship-phone').value;
        let pur_ship_company_name = document.getElementById('pur-ship-company-name').value;
        let lpo_number = document.getElementById('pur-po').value;
        let date = document.getElementById('pur-date').value;
        let due_date = document.getElementById('pur-date-2').value;
        let currency = document.getElementById('currency').value;
        let ref = lpo_number;
        let tax = document.getElementById("tax").value;
        let discount = document.getElementById("discount").value;
        let items_array = get_table_items();
        let total = get_items_total(items_array);
     
        total = discount>0? total - discount : total;
            total = tax>0 ? total + (total * (tax / 100)) : total;
             
        // let ref = "lpo/" + pur_company_name + "/" + lpo_number;
        if(pur_company_name.length < 2){
            alert("please select customer");
            return;
        }
        if(status==='active'){
            if (pur_ship_name.length < 2 || pur_ship_company_name.length < 2 || date.length <2){
            alert('please fill all fields');
            return;
        }
        if(items_array.length<1 )
            {
                alert('please fill atleast one row');
                return;
            }
        }    
        
           
            // console.log("...items",items_array,total);
            // return;
            // let items_array = [],
            //     total = 0;
            // let table = document.getElementById('items_table');
            // console.log("table:" + table);
            // let tr = table.getElementsByTagName('tr');
            // let item, description, quantity, price, obj;
            // let tax = document.getElementById("tax").value;
            // let discount = document.getElementById("discount").value;
            // for (let i = 0; i < tr.length; i++) {
            //     item = tr[i].getElementsByTagName('td')[0].getElementsByTagName('select')[0].value;
            //     description = tr[i].getElementsByTagName('td')[1].getElementsByTagName('input')[0].value;
            //     quantity = tr[i].getElementsByTagName('td')[2].getElementsByTagName('input')[0].value;
            //     price = tr[i].getElementsByTagName('td')[3].getElementsByTagName('input')[0].value;
                
            //     if( item !== "" &&  
            //        !isNaN(quantity) && quantity > 0 &&
            //        !isNaN(price) && price > 0 ){
            //         obj = {
            //         item: item,
            //         description: description,
            //         quantity: quantity,
            //         price: price
            //     };
            //     total += quantity * price;
            //     items_array.push(obj);
            //        }
              

            // };
           
            
            items_array = JSON.stringify(items_array);
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    alert("Sales Order is Generated");
                    btn.disabled = false;

                    var link = document.createElement("a");
                    link.download = 'sales order.xlsx';
                    link.href = '/sales_order_report';
                    link.click();
                    document.location.reload();
                }
            };
            xhttp.open("POST", "/add_lpo", true);
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhttp.send("client=" + encodeURIComponent(pur_company_name) + "&lpo_num=" + encodeURIComponent(lpo_number) + "&date=" + encodeURIComponent(date) 
            + "&due_date=" +
            encodeURIComponent(due_date) + "&ref=" + encodeURIComponent(ref) + "&items_array=" + encodeURIComponent(items_array) 
            + "&total=" + encodeURIComponent(total) + "&tax=" +
            encodeURIComponent(tax) + "&discount=" + encodeURIComponent(discount) + "&pur_name=" + encodeURIComponent(pur_name) + "&v_address=" 
            + encodeURIComponent(pur_vendor_address) +
                "&v_city=" + encodeURIComponent(pur_vendor_city) + "&v_phone=" +
                encodeURIComponent(pur_vendor_phone) + "&s_name=" + encodeURIComponent(pur_ship_name) + "&s_address=" 
                + encodeURIComponent(pur_ship_address) + "&s_city=" +
                encodeURIComponent(pur_ship_city) +
                "&s_phone=" + encodeURIComponent(pur_ship_phone) + "&pur_ship_company_name=" + encodeURIComponent(pur_ship_company_name)
                 + "&status="+status+"&currency=" +
                 encodeURIComponent(currency));



        

    }
    function lpo_refresh(){
        let lpo_num = document.getElementById('input_search_lpo').value;      
        let client = document.getElementById('input_search_client').value;
        let state = document.getElementById('input_search_order_state').value;
        let str = `<ul class="list_cont p-1">`;
            console.log(lpo_num)
        lpos.forEach((lpo)=>{
            console.log(lpo.ref,"----",lpo_num)
            if( (lpo_num ==="" || lpo.ref===lpo_num) && (state === "" || state === lpo.status) && (lpo.client === client || client==="") ){
                        str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`

            }
            // if(state!=="" && state===lpo.status)
            // {             console.log("check")

            //     if(client !== "" && client === lpo.client)
            //     {
            //         str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`

            //     }
            //     else{
            //         str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`

            //     }    
            // }
            // else if(client!=="" && client === lpo.client){
            //     str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`
            // }
            // else{
            //     str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`
            // }
        });
        //  if(client!==""){
        //         lpos.forEach((lpo)=>{
        //             if(status!==""){
        //     if(lpo.client===client){
        //         str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`
        //     }
        // }
        // else{
        //     if(lpo.client===client && lpo.status === status){
        //         str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`
        //     }
        // }
        // });
        //      }
            
             
        // else if(lpo_num!==""){
        //     lpos.forEach((lpo)=>{
        //     if(lpo.ref===lpo_num){
        //         str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`
        //     }
        // }); 
        // }
        // else{
        //     lpos.forEach((lpo)=>{
        //     if(lpo.status===status ){
        //         str += `<li class="card m-1 p-1 pointer" onClick="show('${lpo._id}')" style="font-size:12px">${lpo.ref}</li>`
        //     }
        // }); 
        // }
        
        
        
        str += '</ul>'
        document.getElementById('lpo_list').innerHTML = str;
    

    }
    function lpo_search() {
        let lpo_num = document.getElementById('input_search_lpo');
        let found = false;
        lpos.forEach((lpo) => {
            if (lpo.lpo_number === lpo_num.value || lpo.ref === lpo_num.value) {
                found = true
                show(lpo._id);
            }
        })
        if (!found) {
            swal("LPO# Does Not Exist", "", "error")
        } else {
            swal("LPO# Detail is fetched");

        }
    };

    function show(id) {
        
        lpos.forEach((lpo)=>{
            if(lpo._id === id){
            console.log("selected", lpo);
        document.getElementById('pur-date').value = lpo.date;
        document.getElementById('pur-date-2').value = lpo.due_date;
        document.getElementById('pur-po').value = lpo.lpo_number;
        document.getElementById('pur-po').setAttribute('disabled','disabled')
        document.getElementById('pur-os').value = lpo.status;
        document.getElementById('pur-company-name').value = lpo.client;
        document.getElementById('pur-company-name').setAttribute('disabled','disabled')
        fill_client();
        document.getElementById('tax').value = parseFloat(lpo.tax);
        document.getElementById('discount').value = parseFloat(lpo.discount);
        document.getElementById('currency').value = lpo.currency;
        let str = '',
            str3 = '';
        let str2 = '<option value="">Select Product</option>';
        if(JSON.parse(lpo.items_array).length<1){
            str = `<tr class="d-flex">
                                                                <td class="col-3 td-cells">
                                                                    <select class="form-control" id="pro1category" onclick="load_items(this)"
                                                                        onchange="set_item(this)">
                                                                        <option value="">Select Product</option>
                                                                    </select>
                                                                </td>
                                                                <td class="col-5 td-cells">
                                                                    <input type="text" class="form-control" id="pro1description">
                                                                </td>
                                                                <td class="col-2 td-cells">
                                                                    <input type="text" class="form-control" id="pro1quantityorder"
                                                                        onkeyup="calc(this)">
                                                                </td>
                                                                <td class="col-2 td-cells">
                                                                    <input  type="text" class="form-control" id="pro1unitprice"
                                                                        onKeyUp="grand_total()"
                                                                        onkeypress="sales_add_new(event)">
                                                                </td>
                        
                                            
                                                            </tr>`;
                                                            document.getElementById('items_table').innerHTML = str;
                                                            items.forEach((item2) => {
                
                    str2 += `<option >` + item2.name + `</option>`;})
                    document.getElementById('pro1category').innerHTML = str2;

            return;
        }
        JSON.parse(lpo.items_array).forEach((item, i) => {
            str2 = '<option value="">Select Product</option>';
            str3 = `<td class="col-5 td-cells">
                                <input type="text" class="form-control" id="pro${i+1}description">
                            </td>
                            <td class="col-2 td-cells">
                                <input type="text" class="form-control" id="pro${i+1}quantityorder">
                            </td>
                            <td class="col-2 td-cells">
                                <input type="text" class="form-control" id="pro${i+1}unitprice" onkeypress="sales_add_new(event)">
                            </td>`;
            items.forEach((item2) => {
                // console.log("item p",item,"item o",item2)

                if (item2.name === item.item) {
                    console.log("matched")
                    str2 += `<option selected="selected">` + item2.name + `</option>`;
                    str3 = `<td class="col-5 td-cells">
                                <input type="text" class="form-control" id="pro${i+1}description" value="${item.description}">
                            </td>
                            <td class="col-2 td-cells">
                                <input type="text" class="form-control" id="pro${i+1}quantityorder" value="${item.quantity}">
                            </td>
                            <td class="col-2 td-cells">
                                <input type="text" value="${item.price}" class="form-control" id="pro${i+1}unitprice" onkeypress="sales_add_new(event)">
                            </td>`;

                    // set_item2(item2.name.toString());
                } else {
                    console.log("check")
                    str2 += `<option>` + item2.name + `</option>`;

                }
            })

            str += ` <tr class="d-flex">
                            <td class="col-3 td-cells">
                                <select class="form-control" id="pro${i+1}category" onclick="load_items(this)" onchange="set_item(this)">
                                ${str2}
                                    </select>
                            </td>
                            ${str3}
                        </tr>`;
        });
        document.getElementById('items_table').innerHTML = str;
        total_qty();
        grand_total();
    }
        })
            }
</script>
<script>
    let old_currency = "PKR";

    function apply_currency(e) {
        old_currency = e.value;
    }

    function currency_effect(e) {
        factor = 1;
        factorold = 1;
        switch (old_currency) {
            case "PKR":
                factorold = 1;
                break;
            case "USD":
                factorold = USD
                break;
            case "EURO":
                factorold = EURO
                break;
            case "GBP":
                factorold = GBP
                break;
            case "AED":
                factorold = AED
                break;

        }
        switch (e.value) {
            case "PKR":
                factor = 1;
                break;
            case "USD":
                factor = USD
                break;
            case "EURO":
                factor = EURO
                break;
            case "GBP":
                factor = GBP
                break;
            case "AED":
                factor = AED
                break;
        }
        let table = document.getElementById('items_table');

        let tr = table.getElementsByTagName('tr');
        for (let i = 0; i < tr.length; i++) {

            tr[i].getElementsByTagName('td')[3].getElementsByTagName('input')[0].value = (tr[i].getElementsByTagName(
                'td')[3].getElementsByTagName('input')[0].value * factorold / factor).toFixed(2);



        };
    }
    //new functions
    function new_order(){
        if(        confirm("do you really want to reload? existing changes will be discarded!")){
            window.location.reload();

        }
    }
    function delete_order(){
            if(confirm("do you really want to delete this sales order?")){
            let ref = document.getElementById('pur-po').value;
            fetch('/delete_lpo',{
                method:'POST',
                headers:{
                    'Content-Type': 'application/json'
                },
                body:JSON.stringify({ref:ref}),

            }).then(data=>data.json())
            .then(res=>{
                if(res.success){
                    alert("Sales order is deleted");
                    window.location.reload();
                }
                console.log(res)
            })
        }
    }
    function cancel_order(){
            let ref = document.getElementById('pur-po').value;
    }
    function save_order(){
        var link = document.createElement("a");
                    link.download = 'sales order.xlsx';
                    link.href = '/sales_order_report';
                    link.click();
                    return;
        let btn= {};
        generate_lpo(btn,'draft')
    }
</script>


</html>